<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多人视频聊天室 - 特效快照</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.1.3/dist/socket.io.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --dark-color: #1b263b;
            --light-color: #f8f9fa;
            --success-color: #4cc9f0;
            --danger-color: #f72585;
            --warning-color: #f8961e;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: #f0f2f5;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .join-form {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
        }

        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        input[type="text"]:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        button:active {
            transform: translateY(0);
        }

        button i {
            font-size: 18px;
        }

        #videosContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-container {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            background-color: white;
            transition: var(--transition);
        }

        .video-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        #localVideoContainer {
            border: 3px solid var(--success-color);
        }

        .video-container video {
            width: 100%;
            height: auto;
            background-color: #000;
            display: block;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .video-label i {
            font-size: 12px;
        }

        .controls {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
        }

        .controls h2 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls h2 i {
            color: var(--accent-color);
        }

        .snapshot-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            background-color: white;
            flex: 1;
            min-width: 200px;
            transition: var(--transition);
        }

        select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        #snapshotStatus {
            flex: 1;
            min-width: 100%;
            padding: 10px;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
            text-align: center;
        }

        .snapshot-result {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: none;
        }

        .snapshot-result h2 {
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .snapshot-result h2 i {
            color: var(--accent-color);
        }

        #processedSnapshotImg {
            width: 100%;
            max-width: 500px;
            height: auto;
            border-radius: var(--border-radius);
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #snapshotCanvas {
            display: none;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .status-offline {
            background-color: var(--danger-color);
        }

        @media (max-width: 768px) {
            .join-form {
                flex-direction: column;
            }
            
            .form-group, select, button {
                width: 100%;
            }
            
            #videosContainer {
                grid-template-columns: 1fr;
            }
        }

        /* 加载动画 */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-video"></i> 多人视频聊天室</h1>
            <p>与朋友视频聊天并拍摄特效快照</p>
        </header>

        <div class="join-form">
            <div class="form-group">
                <label for="roomInput"><i class="fas fa-door-open"></i> 房间号</label>
                <input type="text" id="roomInput" value="defaultRoom" placeholder="输入房间号">
            </div>
            <div class="form-group">
                <label for="usernameInput"><i class="fas fa-user"></i> 用户名</label>
                <input type="text" id="usernameInput" placeholder="输入你的名字">
            </div>
            <button onclick="joinRoom()"><i class="fas fa-sign-in-alt"></i> 加入房间</button>
        </div>

        <div id="videosContainer">
            <div id="localVideoContainer" class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="video-label">
                    <span class="status-indicator status-online"></span>
                    <span id="localVideoLabel">你</span>
                </div>
                <canvas id="snapshotCanvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <h2><i class="fas fa-camera-retro"></i> 特效快照</h2>
            <div class="snapshot-controls">
                <select id="effectSelect">
                    <option value="enlarge">哈哈镜放大</option>
                    <option value="reduce">哈哈镜缩小</option>
                    <option value="blur">模糊效果</option>
                    <option value="edge_detection">边缘检测</option>
                </select>
                <button onclick="takeSnapshot()"><i class="fas fa-camera"></i> 拍摄特效照片</button>
                <p id="snapshotStatus"></p>
            </div>
        </div>

        <div class="snapshot-result" id="processedSnapshot">
            <h2><i class="fas fa-image"></i> 处理后的快照</h2>
            <img id="processedSnapshotImg" src="" alt="Processed Snapshot">
        </div>
    </div>

    <script>
        // 这里放置之前的JavaScript代码，保持不变
        let socket;
        let currentRoom;
        let currentUsername;
        const localVideo = document.getElementById('localVideo');
        const videosContainer = document.getElementById('videosContainer');
        const peerConnections = {}; // { remoteUsername: RTCPeerConnection_instance }
        let localStream;
        const snapshotCanvas = document.getElementById('snapshotCanvas');
        const effectSelect = document.getElementById('effectSelect');
        const snapshotStatus = document.getElementById('snapshotStatus');
        const processedSnapshotDiv = document.getElementById('processedSnapshot');
        const processedSnapshotImg = document.getElementById('processedSnapshotImg');

        // STUN 服务器列表
        const iceServers = {
            iceServers: [{
                urls: 'stun:stun.l.google.com:19302'
            }]
        };

        // 获取本地媒体流
        async function getLocalStream() {
             try {
                 localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                 localVideo.srcObject = localStream;
                 console.log('本地媒体流获取成功');
             } catch (error) {
                 console.error('获取媒体流失败:', error);
                 alert('无法获取摄像头和麦克风权限，请检查设置。');
             }
        }

        // 创建 RTCPeerConnection
        function createPeerConnection(remoteUsername) {
            console.log(`为用户 ${remoteUsername} 创建 PeerConnection`);
            const peerConnection = new RTCPeerConnection(iceServers);
            peerConnections[remoteUsername] = peerConnection;

            // 添加本地流的轨道
            if (localStream) {
                 localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                 console.log(`本地流轨道添加到 ${remoteUsername} 的 PeerConnection`);
            } else {
                 console.error("本地流未获取，无法添加到 PeerConnection!");
            }

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    console.log(`发送 ICE candidate 给 ${remoteUsername}`);
                    socket.emit('candidate', {
                        room: currentRoom,
                        candidate: event.candidate,
                        to_username: remoteUsername,
                        from_username: currentUsername
                    });
                }
            };

            peerConnection.ontrack = event => {
                console.log(`接收到来自 ${remoteUsername} 的远程流`);
                let remoteVideoContainer = document.getElementById(`video-container-${remoteUsername}`);
                let remoteVideo = document.getElementById(`video-${remoteUsername}`);

                if (!remoteVideoContainer) {
                    remoteVideoContainer = document.createElement('div');
                    remoteVideoContainer.id = `video-container-${remoteUsername}`;
                    remoteVideoContainer.className = 'video-container';
                    videosContainer.appendChild(remoteVideoContainer);

                    remoteVideo = document.createElement('video');
                    remoteVideo.id = `video-${remoteUsername}`;
                    remoteVideo.autoplay = true;
                    remoteVideo.playsinline = true;
                    remoteVideoContainer.appendChild(remoteVideo);

                    const label = document.createElement('div');
                    label.className = 'video-label';
                    label.innerHTML = `<span class="status-indicator status-online"></span><span>${remoteUsername}</span>`;
                    remoteVideoContainer.appendChild(label);
                }

                if (event.streams && event.streams[0]) {
                    remoteVideo.srcObject = event.streams[0];
                } else {
                    if (!remoteVideo.srcObject) {
                         remoteVideo.srcObject = new MediaStream();
                    }
                     remoteVideo.srcObject.addTrack(event.track);
                }
            };

            peerConnection.onconnectionstatechange = event => {
                console.log(`PeerConnection state for ${remoteUsername}: ${peerConnection.connectionState}`);
                const label = document.querySelector(`#video-container-${remoteUsername} .video-label span.status-indicator`);
                if (label) {
                    if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
                        label.className = 'status-indicator status-offline';
                        setTimeout(() => removeUserVideo(remoteUsername), 3000);
                    } else {
                        label.className = 'status-indicator status-online';
                    }
                }
            };

            return peerConnection;
        }

         async function sendOffer(remoteUsername) {
             const peerConnection = peerConnections[remoteUsername];
             if (!peerConnection) return;
             try {
                 const offer = await peerConnection.createOffer();
                 await peerConnection.setLocalDescription(offer);
                 socket.emit('offer', { room: currentRoom, offer: offer, to_username: remoteUsername, from_username: currentUsername });
             } catch (error) { console.error(`创建或发送 Offer 失败给 ${remoteUsername}:`, error); }
         }

         async function sendAnswer(remoteUsername) {
             const peerConnection = peerConnections[remoteUsername];
             if (!peerConnection) return;
             try {
                  const answer = await peerConnection.createAnswer();
                 await peerConnection.setLocalDescription(answer);
                 socket.emit('answer', { room: currentRoom, answer: answer, to_username: remoteUsername, from_username: currentUsername });
             } catch (error) { console.error(`创建或发送 Answer 失败给 ${remoteUsername}:`, error); }
         }

        function removeUserVideo(username) {
             console.log(`移除用户 ${username} 的视频`);
             const videoContainer = document.getElementById(`video-container-${username}`);
             if (videoContainer) { videosContainer.removeChild(videoContainer); }
             if (peerConnections[username]) {
                 peerConnections[username].close();
                 delete peerConnections[username];
             }
        }

        // --- 特效快照功能 ---
        function takeSnapshot() {
             if (!localStream || !localVideo.srcObject) {
                 alert('本地视频流未启动！');
                 return;
             }

             const effectType = effectSelect.value;
             if (!effectType) {
                 alert('请选择一个特效！');
                 return;
             }

             // 设置 Canvas 尺寸与视频流一致
             snapshotCanvas.width = localVideo.videoWidth;
             snapshotCanvas.height = localVideo.videoHeight;

             // 在 Canvas 上绘制当前视频帧
             const context = snapshotCanvas.getContext('2d');
             context.drawImage(localVideo, 0, 0, snapshotCanvas.width, snapshotCanvas.height);

             // 将 Canvas 内容导出为 Base64 编码的图片数据 URL
             const imageDataUrl = snapshotCanvas.toDataURL('image/png');

             // 显示处理状态
             snapshotStatus.innerHTML = `<div class="loader"></div> 正在处理快照 (${effectType})...`;
             processedSnapshotDiv.style.display = 'none';

             // 通过 SocketIO 发送给服务器
             socket.emit('process_snapshot', {
                 image_data_url: imageDataUrl,
                 effect: effectType
             });

             console.log(`Sent snapshot for effect '${effectType}' to server.`);
        }

        // --- SocketIO 事件监听 (合并视频聊天和快照处理) ---
        function setupSocketListeners() {
             socket = io();
             console.log('Socket connecting...');

             socket.on('connect', () => {
                 console.log('Socket.IO connected.');
                 // 连接成功后，获取本地流并加入房间
                 getLocalStream().then(() => {
                     if (localStream) {
                         const room = document.getElementById('roomInput').value.trim();
                         const username = document.getElementById('usernameInput').value.trim();
                         if (room && username) {
                             currentRoom = room;
                             currentUsername = username;
                             document.getElementById('localVideoLabel').textContent = username;
                             socket.emit('join', { room: currentRoom, username: currentUsername });
                         } else {
                              console.log("请填写房间号和用户名，然后点击加入房间。");
                         }
                     }
                 });
             });

             socket.on('disconnect', () => {
                console.log('Socket.IO disconnected.');
                for (const user in peerConnections) {
                     removeUserVideo(user);
                }
                peerConnections = {};
                snapshotStatus.innerHTML = '<span class="status-indicator status-offline"></span> 已断开连接';
                processedSnapshotDiv.style.display = 'none';
             });

             socket.on('join_error', (data) => {
                 alert('加入房间失败: ' + data.message);
                 console.error('Join error:', data.message);
                 if(socket) socket.disconnect();
             });

             // WebRTC 信令事件
             socket.on('users_in_room', async (data) => {
                console.log('收到现有用户列表:', data.users);
                const existingUsers = data.users;
                for (const user of existingUsers) {
                    if (user !== currentUsername) {
                        createPeerConnection(user);
                        await sendOffer(user);
                    }
                }
             });

             socket.on('user_joined', async (data) => {
                 console.log('新用户加入:', data.username);
                 const newUser = data.username;
                 if (newUser !== currentUsername) {
                     createPeerConnection(newUser);
                 }
             });

             socket.on('user_left', (data) => {
                 console.log('用户离开:', data.username);
                 removeUserVideo(data.username);
             });

             socket.on('offer', async (data) => {
                 console.log('收到 Offer 来自:', data.from_username);
                 const fromUser = data.from_username;
                 const offer = data.offer;
                 let peerConnection = peerConnections[fromUser];
                 if (!peerConnection) {
                      peerConnection = createPeerConnection(fromUser);
                      if (localStream) {
                         localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                     }
                 }
                 try {
                     await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                     await sendAnswer(fromUser);
                 } catch (error) { console.error(`处理 Offer 失败来自 ${fromUser}:`, error); }
             });

             socket.on('answer', async (data) => {
                 console.log('收到 Answer 来自:', data.from_username);
                 const fromUser = data.from_username;
                 const answer = data.answer;
                 const peerConnection = peerConnections[fromUser];
                  if (!peerConnection) { console.error(`收到 Answer 但未找到与用户 ${fromUser} 的 PeerConnection`); return; }
                 try {
                     await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                 } catch (error) { console.error(`处理 Answer 失败来自 ${fromUser}:`, error); }
             });

             socket.on('candidate', async (data) => {
                 const fromUser = data.from_username;
                 const candidate = data.candidate;
                 const peerConnection = peerConnections[fromUser];
                  if (!peerConnection) return;
                 try {
                     if (candidate) { await peerConnection.addIceCandidate(new RTCIceCandidate(candidate)); }
                 } catch (error) { console.error(`添加 ICE Candidate 失败来自 ${fromUser}:`, error); }
             });

             // --- 特效快照结果事件 ---
             socket.on('snapshot_processed', (data) => {
                 const taskId = data.task_id;
                 const status = data.status;
                 const message = data.message;
                 const imageDataUrl = data.image_data_url;

                 console.log(`Received processed snapshot result for task ${taskId} with status: ${status}`);

                 if (status === 'completed' && imageDataUrl) {
                     snapshotStatus.innerHTML = '<span style="color: var(--success-color)">✓</span> 快照处理完成！';
                     processedSnapshotImg.src = imageDataUrl;
                     processedSnapshotDiv.style.display = 'block';
                 } else {
                     snapshotStatus.innerHTML = `<span style="color: var(--danger-color)">✗</span> 快照处理失败: ${message || '未知错误'}`;
                     processedSnapshotDiv.style.display = 'none';
                 }
             });
        }

        function joinRoom() {
             const room = document.getElementById('roomInput').value.trim();
             const username = document.getElementById('usernameInput').value.trim();

             if (!room || !username) {
                 alert('请输入房间号和用户名');
                 return;
             }

             if (!socket || !socket.connected) {
                  setupSocketListeners();
             } else {
                 console.log(`正在离开房间 ${currentRoom} 用户 ${currentUsername} 并加入新房间 ${room} 用户 ${username}`);
                 socket.emit('leave', { room: currentRoom, username: currentUsername });

                for (const user in peerConnections) {
                     removeUserVideo(user);
                }
                peerConnections = {};

                 currentRoom = room;
                 currentUsername = username;
                 getLocalStream().then(() => {
                     if (localStream) {
                          socket.emit('join', { room: currentRoom, username: currentUsername });
                     }
                 });
             }
        }
    </script>
</body>
</html>